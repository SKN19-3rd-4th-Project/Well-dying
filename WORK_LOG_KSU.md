# ê°œì¸ ì‘ì—…ì‚¬í•­ (KSU)

Well Dying ì±—ë´‡ ì‹œìŠ¤í…œ ê°œë°œ ì‘ì—… ë¡œê·¸

---

## ğŸ“‹ ì‘ì—… ìš”ì•½

### 1. ìœ ì‚°Â·ìƒì† ê´€ë ¨ ë°ì´í„° ìˆ˜ì§‘ ë° PDF ì €ì¥

**ìˆ˜ì§‘í•œ ë°ì´í„°:**
- ë¯¼ë²• ìƒì†í¸
- êµ­ì„¸ì²­ ìƒì†Â·ì¦ì—¬ ì„¸ê¸ˆìƒì‹ I, II
- ìƒì†ì„¸ ë° ì¦ì—¬ì„¸ë²•
- ì‚¬ë§ì ë° í”¼í›„ê²¬ì¸ ë“± ì¬ì‚°ì¡°íšŒ í†µí•©ì²˜ë¦¬ ì‹ ì²­ ì›¹ ìŠ¤í¬ë˜í•‘
- ì¬ì‚°ì¡°íšŒ í†µí•©ì²˜ë¦¬ì— ê´€í•œ ê¸°ì¤€ (í–‰ì •ì•ˆì „ë¶€)

**ì‘ì—… ë‚´ìš©:**
- ë²•ë¥  ë¬¸ì„œ ë° ì›¹ ì½˜í…ì¸ ë¥¼ PDF í˜•ì‹ìœ¼ë¡œ ìˆ˜ì§‘
- ì´ 6ê°œ PDF íŒŒì¼ í™•ë³´ (`data/raw/` ë””ë ‰í† ë¦¬)

---

### 2. PDF â†’ JSONL â†’ ChromaDB ì €ì¥

**ì „ì²˜ë¦¬ íŒŒì´í”„ë¼ì¸ êµ¬ì¶•:**

#### 2.1 PDF í…ìŠ¤íŠ¸ ì¶”ì¶œ (`chatbot/src/preprocessing.py`)
- **ë¼ì´ë¸ŒëŸ¬ë¦¬**: PyMuPDF (fitz)
- **ì²˜ë¦¬ ê³¼ì •**:
  1. PDFì—ì„œ í…ìŠ¤íŠ¸ ì¶”ì¶œ
  2. ì œì–´ ë¬¸ì ì œê±° (ì¤„ë°”ê¿ˆ, íƒ­ ë“±)
  3. í•œê¸€ ë‹¨ì–´ ë³µì› (ë„ì–´ì“°ê¸° ì˜¤ë¥˜ ìˆ˜ì •)
  4. ì²­í‚¹ ì „ëµ:
     - **ë²•ì¡°ë¬¸ ë¬¸ì„œ**: ì¡°ë¬¸ ë‹¨ìœ„ë¡œ ë¶„í•  (ì˜ˆ: "ì œ1ì¡°", "ì œ2ì¡°")
     - **ì¼ë°˜ ë¬¸ì„œ**: ë¬¸ë‹¨ ë‹¨ìœ„ë¡œ ë¶„í•  (500ì ì´í•˜)
  5. **ì²­í¬ ì˜¤ë²„ë© ì ìš©**: 100ì ì˜¤ë²„ë©ìœ¼ë¡œ ë¬¸ë§¥ ë³´ì¡´

#### 2.2 JSONL í˜•ì‹ìœ¼ë¡œ ì €ì¥
- ê° ì²­í¬ë¥¼ JSON ê°ì²´ë¡œ ë³€í™˜
- ë©”íƒ€ë°ì´í„° í¬í•¨:
  - `id`: ê³ ìœ  ì‹ë³„ì
  - `text`: ë³¸ë¬¸ ë‚´ìš©
  - `title`: ì œëª©
  - `source`: ì¶œì²˜ íŒŒì¼ëª…
  - `category`: ì¹´í…Œê³ ë¦¬
- ì¶œë ¥: `data/processed/*.jsonl` (ì´ 6ê°œ íŒŒì¼)

#### 2.3 ChromaDB ì¸ë±ì‹± (`chatbot/src/indexer.py`)
- **ì„ë² ë”© ëª¨ë¸**: OpenAI `text-embedding-3-small` (1536ì°¨ì›)
- **ë²¡í„° DB**: ChromaDB (ë¡œì»¬ ì €ì¥)
- **ì»¬ë ‰ì…˜**: `well_dying_legacy_data`
- **ì €ì¥ ìœ„ì¹˜**: `data/chroma_db/`

---

### 3. íŒ€ì› ë°ì´í„° í†µí•© ë° JSONL í†µí•©

**í†µí•© ëŒ€ìƒ ë°ì´í„°:**

| ì¹´í…Œê³ ë¦¬ | ë‹´ë‹¹ì | ë°ì´í„° ìœ í˜• | íŒŒì¼ ìˆ˜ |
|---------|--------|------------|---------|
| Cyber Legacy (ì‚¬ì´ë²„ ìœ ì‚°) | PJH | JSON | 8ê°œ |
| Subsidy (ì •ë¶€ ì§€ì›ê¸ˆ) | LSW | CSV, JSON | 8ê°œ |
| Funeral (ì¥ë¡€ ì ˆì°¨) | BSJ | CSV | 5ê°œ |
| Persona (í†¤ì•¤ë§¤ë„ˆ) | ê³µí†µ | CSV, JSON | 4ê°œ |

**í†µí•© ì‘ì—… (`scripts/merge_data.py`):**

1. **ë°ì´í„° ìˆ˜ì§‘**:
   - `data/processed/online_pjh_json/`: ì¹´ì¹´ì˜¤, ë„¤ì´ë²„, êµ¬ê¸€ ê³„ì • ê´€ë¦¬
   - `data/processed/subsidy_lsw_csv_json/`: ì¥ë¡€ì‹ì¥, í™”ì¥í„°, ë¬˜ì§€ ì •ë³´
   - `data/processed/funeral_bsj_json/`: ì¥ë¡€ ì‹œì„¤ ë°ì´í„°
   - `data/processed/routine_chatbot/`: ê³µê° ì§ˆë¬¸, ëŒ€í™” ê·œì¹™
   - `data/processed/unified_well_dying_data.jsonl`: í†µí•© ë°ì´í„°
   (ë£¨í‹´ê¹Œì§€ëŠ” ì ìš© ì•ˆë˜ì–´ìˆìŒ)

2. **ìŠ¤í‚¤ë§ˆ í‘œì¤€í™”**:
   ```json
   {
     "instruction": "ì‚¬ìš©ì ì§ˆë¬¸ ë˜ëŠ” ì£¼ì œ",
     "context": "ë³¸ë¬¸ ë‚´ìš©",
     "metadata": {
       "category": "ì¹´í…Œê³ ë¦¬",
       "source_file": "ì›ë³¸ íŒŒì¼ëª…",
       "file_type": "csv ë˜ëŠ” json"
     }
   }
   ```

3. **ì¤‘ë³µ ì œê±°**:
   - Context ë‚´ìš© ê¸°ì¤€ìœ¼ë¡œ 100% ì¼ì¹˜í•˜ëŠ” ë°ì´í„° ì œê±°
   - Persona ì¹´í…Œê³ ë¦¬ì—ì„œ ì£¼ë¡œ ë°œìƒ

4. **ì¶œë ¥**:
   - `data/processed/unified_well_dying_data.jsonl`
   - **ì´ 2,754ê°œ ë°ì´í„°**

**ì¸ì½”ë”© ì²˜ë¦¬:**
- UTF-8 ìš°ì„  ì‹œë„
- ì‹¤íŒ¨ ì‹œ CP949, EUC-KR ìˆœì°¨ ì‹œë„

---

### 4. Pinecone DB ì—°ë™ ì‹œë„ ë° ë¡œì»¬ ì‚¬ìš©

#### 4.1 Pinecone ì—°ë™ ì‹œë„

**ì‹œë„ ë‚´ìš©:**
- Pinecone Serverless Index ìƒì„± (`well-dying-index`)
- API Key ì„¤ì • ë° í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™”

**ë¬¸ì œ ë°œìƒ:**
```
ForbiddenException: You've reached the max serverless indexes allowed in project Default (5).
```

**ì›ì¸:**
- Pinecone Free TierëŠ” ìµœëŒ€ 5ê°œ ì¸ë±ìŠ¤ë§Œ ìƒì„± ê°€ëŠ¥
- ê¸°ì¡´ íŒ€ì› ë°ì´í„°ê°€ ì´ë¯¸ 5ê°œ ì¸ë±ìŠ¤ë¥¼ ì‚¬ìš© ì¤‘:
  1. `digital-legacy-kb`
  2. `funeral-services`
  3. `funeral-index`
  4. `talk-assets`
  5. `temp`

#### 4.2 í•´ê²° ë°©ë²•: Namespace í™œìš©

**ì„ íƒí•œ ì „ëµ:**
- ê¸°ì¡´ `temp` ì¸ë±ìŠ¤ë¥¼ **ì¬ì‚¬ìš©**
- **Namespace ë¶„ë¦¬**ë¥¼ í†µí•´ ë°ì´í„° ê²©ë¦¬:
  - ê¸°ì¡´ íŒ€ì› ë°ì´í„°: `temp` (default namespace)
  - ìœ ì‚°Â·ìƒì† ë°ì´í„°: `temp` (namespace: `well-dying`)

**êµ¬í˜„ (`scripts/index_to_pinecone.py`):**
```python
INDEX_NAME = "temp"
NAMESPACE = "well-dying"

index.upsert(vectors=vectors, namespace=NAMESPACE)
```

**ê²°ê³¼:**
- âœ… 2,754ê°œ ë°ì´í„° ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œ
- âœ… ê¸°ì¡´ íŒ€ì› ë°ì´í„°ì™€ ì™„ì „íˆ ë¶„ë¦¬
- âœ… ì¸ë±ìŠ¤ ìƒì„± í•œë„ ë¬¸ì œ í•´ê²°

**ì‹¤ì œ ì €ì¥ ìœ„ì¹˜:**
```
ğŸ“ Pinecone Index URL: https://temp-wb03sz2.svc.aped-4627-b74a.pinecone.io
â”œâ”€â”€ Index Name: temp
â”œâ”€â”€ Region: aped-4627-b74a (AWS Asia Pacific)
â””â”€â”€ Unique ID: wb03sz2
```

**Namespace êµ¬ì¡°:**
```
ğŸ“¦ temp ì¸ë±ìŠ¤
â”œâ”€â”€ ğŸ“ default namespace
â”‚   â””â”€â”€ ê¸°ì¡´ íŒ€ì› ë°ì´í„° (ê±´ë“œë¦¬ì§€ ì•ŠìŒ)
â”‚
â””â”€â”€ ğŸ“ well-dying namespace â† ğŸ¯ ìš°ë¦¬ ë°ì´í„° ì €ì¥ ìœ„ì¹˜!
    â”œâ”€â”€ ìœ ì‚°ìƒì† ìë£Œ (6ê°œ PDF â†’ JSONL)
    â”‚   - ë¯¼ë²• ìƒì†í¸
    â”‚   - ìƒì†ì„¸ë²•
    â”‚   - êµ­ì„¸ì²­ ì„¸ê¸ˆìƒì‹ I, II
    â”‚   - ì¬ì‚°ì¡°íšŒ í†µí•©ì²˜ë¦¬
    â””â”€â”€ í†µí•© íŒ€ì› ìë£Œ
        â”œâ”€â”€ Cyber Legacy (PJH)
        â”œâ”€â”€ Subsidy (LSW)
        â”œâ”€â”€ Funeral (BSJ)
        â””â”€â”€ Persona (ê³µí†µ)
    
    ì´ 2,754ê°œ ë°ì´í„°
```

**ê²€ìƒ‰ ì‹œ ë™ì‘:**
```python
# chatbot/src/chatbot.pyì˜ search_node
index = pc.Index("temp")  # temp ì¸ë±ìŠ¤ ì ‘ê·¼
results = index.query(
    vector=query_embedding,
    top_k=15,
    namespace="well-dying"  # â† well-dying namespaceë§Œ ê²€ìƒ‰!
)
```

**ì™œ tempë¥¼ ì„ íƒí–ˆë‚˜?**
1. ì´ë¦„ì´ "temp"(ì„ì‹œ)ë¼ì„œ ìƒëŒ€ì ìœ¼ë¡œ ëœ ì¤‘ìš”í•´ ë³´ì„
2. Namespace ê¸°ëŠ¥ìœ¼ë¡œ ê¸°ì¡´ ë°ì´í„°ì™€ ì™„ì „ ë¶„ë¦¬ ê°€ëŠ¥
3. ìƒˆ ì¸ë±ìŠ¤ ìƒì„± ì—†ì´ ê¸°ì¡´ ì¸í”„ë¼ í™œìš©
4. ë‹¤ë¥¸ ì¸ë±ìŠ¤ë“¤(`digital-legacy-kb`, `funeral-services` ë“±)ì€ ì´ë¦„ìƒ ì¤‘ìš”í•´ ë³´ì—¬ì„œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ

#### 4.3 ìµœì¢… DB ì„ íƒ ë° í˜„ì¬ ìƒíƒœ

| êµ¬ë¶„ | ChromaDB (ë¡œì»¬) | Pinecone (í´ë¼ìš°ë“œ) |
|-----|----------------|-------------------|
| ì¥ì  | ë¬´ë£Œ, ë¹ ë¥¸ ê°œë°œ | í™•ì¥ì„±, íŒ€ ê³µìœ , ì–´ë””ì„œë“  ì ‘ê·¼ |
| ë‹¨ì  | ë¡œì»¬ì—ë§Œ ì €ì¥ | ì¸ë±ìŠ¤ ìˆ˜ ì œí•œ (Free: 5ê°œ) |
| **ìµœì¢… ì„ íƒ** | âŒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ | âœ… **í”„ë¡œë•ì…˜ì—ì„œ ì‹¤ì œ ì‚¬ìš© ì¤‘** |

**í˜„ì¬ DB ì‚¬ìš© í˜„í™©:**

âœ… **Pinecone (ì‹¤ì œ ì‚¬ìš© ì¤‘)**
- **ì €ì¥ ìœ„ì¹˜**: `temp` ì¸ë±ìŠ¤ / `well-dying` namespace
- **ì €ì¥ ë°ì´í„°**: 
  - ìœ ì‚°ìƒì† ìë£Œ (ë‚´ê°€ ìˆ˜ì§‘í•œ 6ê°œ PDF)
  - íŒ€ì› í†µí•© ìë£Œ (Cyber, Subsidy, Funeral, Persona)
  - â†’ **ì´ 2,754ê°œ ëª¨ë‘ Pineconeì— í†µí•© ì €ì¥**
- **ì‚¬ìš© íŒŒì¼**: `chatbot/src/chatbot.py` (ì‹¤ì œ ì±—ë´‡)

âŒ **ChromaDB (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)**
- **ì½”ë“œë§Œ ë‚¨ì•„ìˆìŒ**: `chatbot/src/indexer.py` (ë ˆê±°ì‹œ)
- **ì±—ë´‡ì—ì„œ ì°¸ì¡° ì•ˆ í•¨**: `data/chroma_db/` í´ë” ë¬´ì‹œë¨
- **ì´ˆê¸° ê°œë°œìš©ìœ¼ë¡œë§Œ ì‚¬ìš©**í–ˆê³  í˜„ì¬ëŠ” ì™„ì „íˆ Pineconeìœ¼ë¡œ ì „í™˜

**ì •ë¦¬:**
- ë‚´ ìë£Œë“  íŒ€ ìë£Œë“  **ëª¨ë“  ë°ì´í„°ê°€ Pineconeì— í†µí•©**ë˜ì–´ ìˆìŒ
- ChromaDBëŠ” ê°œë°œ ì´ˆê¸° í”ì ì¼ ë¿, í˜„ì¬ ì±—ë´‡ì€ 100% Pineconeë§Œ ì‚¬ìš©

---

### 5. ì±—ë´‡ ì‘ë™ ì›ë¦¬ ë° ì‚¬ìš© ê¸°ìˆ 

## ğŸ¤– ì±—ë´‡ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

### 5.1 ê¸°ìˆ  ìŠ¤íƒ ê°œìš”

| ê³„ì¸µ | ê¸°ìˆ  | ì—­í•  |
|-----|------|------|
| **Frontend** | Streamlit | ì›¹ UI |
| **Orchestration** | LangGraph | ì›Œí¬í”Œë¡œìš° ê´€ë¦¬ |
| **LLM Integration** | LangChain | í”„ë¡¬í”„íŠ¸ ê´€ë¦¬, LLM í˜¸ì¶œ |
| **Vector DB** | Pinecone | ë²¡í„° ê²€ìƒ‰ |
| **LLM** | GPT-4o mini | ì¿¼ë¦¬ ì¬ì‘ì„±, ë‹µë³€ ìƒì„± |
| **Embeddings** | text-embedding-3-small | ë²¡í„° ì„ë² ë”© |
| **State Management** | MemorySaver | ëŒ€í™” ê¸°ë¡ ìœ ì§€ |

---

### 5.2 LangGraph ì›Œí¬í”Œë¡œìš° ìƒì„¸

**LangGraphë€?**
- LangChain íŒ€ì´ ê°œë°œí•œ **ìƒíƒœ ê¸°ë°˜ ì›Œí¬í”Œë¡œìš° ê´€ë¦¬ í”„ë ˆì„ì›Œí¬**
- DAG(Directed Acyclic Graph) êµ¬ì¡°ë¡œ AI ì• í”Œë¦¬ì¼€ì´ì…˜ íë¦„ì„ ì •ì˜
- ê° ë…¸ë“œëŠ” ë…ë¦½ì ì¸ í•¨ìˆ˜ë¡œ, ìƒíƒœë¥¼ ì…ë ¥ë°›ì•„ ìƒˆë¡œìš´ ìƒíƒœë¥¼ ë°˜í™˜

**ì›Œí¬í”Œë¡œìš° êµ¬ì¡° (`chatbot/src/chatbot.py`):**

```
[User Query] 
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  rewrite_node   â”‚ â† GPT-4o mini (ì¿¼ë¦¬ ì¬ì‘ì„±)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  search_node    â”‚ â† Pinecone (ë²¡í„° ê²€ìƒ‰)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ format_context  â”‚ (ì»¨í…ìŠ¤íŠ¸ í¬ë§·íŒ…)
â”‚     _node       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ generate_node   â”‚ â† GPT-4o mini (ë‹µë³€ ìƒì„±)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
[Answer + Updated State]
```

---

### 5.3 ê° ë…¸ë“œ(Node) ìƒì„¸ ì„¤ëª…

#### **Node 1: rewrite_node (ì¿¼ë¦¬ ì¬ì‘ì„±)**

**ëª©ì :**
- ëª¨í˜¸í•˜ê±°ë‚˜ êµ¬ì–´ì²´ ì§ˆë¬¸ì„ ê²€ìƒ‰ì— ìµœì í™”ëœ í‚¤ì›Œë“œë¡œ ë³€í™˜
- ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ (Recall ê°œì„ )

**ë™ì‘ ê³¼ì •:**
1. ì‚¬ìš©ì ì›ë³¸ ì¿¼ë¦¬ ìˆ˜ì‹ 
2. GPT-4o miniì—ê²Œ ë‹¤ìŒ í”„ë¡¬í”„íŠ¸ ì „ë‹¬:
   ```
   "ì‚¬ìš©ì ì§ˆë¬¸ì„ ê²€ìƒ‰ ì—”ì§„ì— ìµœì í™”ëœ ì¿¼ë¦¬ë¡œ ë³€í™˜"
   - ëª¨í˜¸í•œ í‘œí˜„ â†’ êµ¬ì²´ì  í‚¤ì›Œë“œ
   - ì§€ì—­ëª… â†’ ì •í™•í•œ í–‰ì •êµ¬ì—­ëª…
   - ë¬¸ì˜ í‘œí˜„ â†’ í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸
   ```
3. ì¬ì‘ì„±ëœ ì¿¼ë¦¬ ë°˜í™˜

**ì˜ˆì‹œ:**
- ì…ë ¥: "ë§ˆí¬êµ¬ ì¥ë¡€ì‹ì¥ ì•Œë ¤ì¤˜"
- ì¶œë ¥: "ë§ˆí¬êµ¬ ì¥ë¡€ì‹ì¥ ì¥ë¡€ì‹ì¥ ëª©ë¡ ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ ì‹œì„¤"

**ì‚¬ìš© ê¸°ìˆ :**
- LangChain `ChatOpenAI` í´ë˜ìŠ¤
- `SystemMessage` + `HumanMessage` íŒ¨í„´

---

#### **Node 2: search_node (ë²¡í„° ê²€ìƒ‰)**

**ëª©ì :**
- Pineconeì—ì„œ ì¬ì‘ì„±ëœ ì¿¼ë¦¬ì™€ ìœ ì‚¬í•œ ë¬¸ì„œ ê²€ìƒ‰

**ë™ì‘ ê³¼ì •:**
1. ì¬ì‘ì„±ëœ ì¿¼ë¦¬ë¥¼ ì„ë² ë”© ë²¡í„°ë¡œ ë³€í™˜
   - ëª¨ë¸: `text-embedding-3-small` (1536ì°¨ì›)
2. Pineconeì— ë²¡í„° ì¿¼ë¦¬ ì „ì†¡:
   ```python
   index.query(
       vector=query_embedding,
       top_k=15,  # ìƒìœ„ 15ê°œ ë¬¸ì„œ
       include_metadata=True,
       namespace="well-dying"
   )
   ```
3. ìœ ì‚¬ë„ ê¸°ë°˜ìœ¼ë¡œ ì •ë ¬ëœ ë¬¸ì„œ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜

**ê²€ìƒ‰ ë©”íŠ¸ë¦­:**
- **Cosine Similarity** (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
- Score ë²”ìœ„: 0.0 ~ 1.0 (1.0ì— ê°€ê¹Œìš¸ìˆ˜ë¡ ìœ ì‚¬)

**ì‚¬ìš© ê¸°ìˆ :**
- LangChain `OpenAIEmbeddings`
- Pinecone Python SDK
- Numpy (ë²¡í„° ì—°ì‚°)

---

#### **Node 3: format_context_node (ì»¨í…ìŠ¤íŠ¸ í¬ë§·íŒ…)**

**ëª©ì :**
- ê²€ìƒ‰ëœ ë¬¸ì„œë“¤ì„ LLMì´ ì´í•´í•˜ê¸° ì‰¬ìš´ í˜•íƒœë¡œ êµ¬ì¡°í™”

**ë™ì‘ ê³¼ì •:**
1. ê²€ìƒ‰ ê²°ê³¼(15ê°œ ë¬¸ì„œ) ìˆ˜ì‹ 
2. ì¤‘ë³µ ì œê±° ë° ê´€ë ¨ë„ ìˆœ ì •ë ¬
3. ê° ë¬¸ì„œë¥¼ ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë³€í™˜:
   ```
   [ì¶œì²˜: funeral_homes.csv]
   ì£¼ì œ: ì„œìš¸ ë§ˆí¬êµ¬ ì¥ë¡€ì‹ì¥
   ë‚´ìš©: ì£¼ì†Œ: ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬...
   ì—°ë½ì²˜: 02-XXX-XXXX
   
   ---
   
   [ì¶œì²˜: subsidy_data.json]
   ...
   ```
4. ëª¨ë“  ë¬¸ì„œë¥¼ `\n\n---\n\n`ë¡œ ì—°ê²°

**ì¶œë ¥ ì˜ˆì‹œ:**
```
[ì¶œì²˜: funeral_homes.csv, ìƒì„¸ ì •ë³´]
ì£¼ì†Œ: ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬ í† ì •ë¡œ 6-1 (í•©ì •ë™)
ì‹œì„¤ëª…: ë¶€í™œì˜ì§‘
ì „í™”ë²ˆí˜¸: 070-8282-8223

---

[ì¶œì²˜: cemeteries.csv, ìƒì„¸ ì •ë³´]
...
```

**ì‚¬ìš© ê¸°ìˆ :**
- Python ë¬¸ìì—´ í¬ë§·íŒ…
- ë©”íƒ€ë°ì´í„° ì¶”ì¶œ ë° ì •ë¦¬

---

#### **Node 4: generate_node (ë‹µë³€ ìƒì„±)**

**ëª©ì :**
- ê²€ìƒ‰ëœ ì»¨í…ìŠ¤íŠ¸ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì‚¬ìš©ì ì§ˆë¬¸ì— ë‹µë³€ ìƒì„±
- ëŒ€í™” ê¸°ë¡ì„ ë°˜ì˜í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™” ìœ ì§€

**ë™ì‘ ê³¼ì •:**

1. **System Prompt êµ¬ì„±**:
   ```
   ë‹¹ì‹ ì€ 'Well Dying' ì •ë³´ë¥¼ ì œê³µí•˜ëŠ” ì±—ë´‡ì…ë‹ˆë‹¤.
   - ìœ ì‚°ìƒì†, ì¥ë¡€ì ˆì°¨, ì •ë¶€ì§€ì›ê¸ˆ, ë””ì§€í„¸ ìœ ì‚° ì •ë³´ ì œê³µ
   - ì°¨ë¶„í•˜ê³  ë‹´ë°±í•œ í†¤ì•¤ë§¤ë„ˆ
   - ê³¼ë„í•œ ìœ„ë¡œë‚˜ ê°ì • í‘œí˜„ ì§€ì–‘
   ```

2. **ëŒ€í™” ê¸°ë¡ ë¡œë“œ**:
   - MemorySaverì—ì„œ ìµœê·¼ 5ê°œ ëŒ€í™” ë¡œë“œ
   - í˜•ì‹: `[(HumanMessage, AIMessage), ...]`

3. **Messages ë¦¬ìŠ¤íŠ¸ êµ¬ì„±**:
   ```python
   messages = [
       SystemMessage(content=system_prompt),
       HumanMessage(content="[ì´ì „ ì§ˆë¬¸ 1]"),
       AIMessage(content="[ì´ì „ ë‹µë³€ 1]"),
       ...
       HumanMessage(content="[Context]\n\n[í˜„ì¬ ì§ˆë¬¸]")
   ]
   ```

4. **GPT-4o mini í˜¸ì¶œ**:
   ```python
   llm = ChatOpenAI(
       model="gpt-4o-mini",
       temperature=0.7,  # ì ì ˆí•œ ì°½ì˜ì„±
       max_tokens=1000
   )
   response = llm.invoke(messages)
   ```

5. **ë‹µë³€ ë°˜í™˜ ë° ìƒíƒœ ì—…ë°ì´íŠ¸**:
   - ë‹µë³€ì„ `answer` í•„ë“œì— ì €ì¥
   - í˜„ì¬ ëŒ€í™”ë¥¼ `messages`ì— ì¶”ê°€ (ë‹¤ìŒ í„´ì„ ìœ„í•´)

**ì‚¬ìš© ê¸°ìˆ :**
- LangChain `ChatOpenAI`
- `HumanMessage`, `AIMessage` (LangChain ë©”ì‹œì§€ íƒ€ì…)
- MemorySaver (LangGraph ìƒíƒœ ê´€ë¦¬)

---

### 5.4 ìƒíƒœ ê´€ë¦¬ (GraphState)

**GraphState êµ¬ì¡°:**
```python
class GraphState(TypedDict):
    query: str                          # í˜„ì¬ ì¿¼ë¦¬
    relevant_docs: List[Dict]           # ê²€ìƒ‰ ê²°ê³¼
    context: str                        # í¬ë§·íŒ…ëœ ì»¨í…ìŠ¤íŠ¸
    answer: str                         # ìƒì„±ëœ ë‹µë³€
    sources: List[Dict]                 # ì¶œì²˜ ë©”íƒ€ë°ì´í„°
    num_sources: int                    # ê²€ìƒ‰ëœ ë¬¸ì„œ ìˆ˜
    messages: List[BaseMessage]         # ëŒ€í™” ê¸°ë¡
```

**ìƒíƒœ ì—…ë°ì´íŠ¸ ë°©ì‹:**
- ê° ë…¸ë“œëŠ” `GraphState`ë¥¼ ì…ë ¥ë°›ì•„, **ì¼ë¶€ í•„ë“œë¥¼ ì—…ë°ì´íŠ¸í•œ ìƒˆë¡œìš´ ìƒíƒœë¥¼ ë°˜í™˜**
- LangGraphê°€ ìë™ìœ¼ë¡œ ìƒíƒœë¥¼ ë³‘í•© (Merge)

**ì˜ˆì‹œ:**
```python
def search_node(state: GraphState) -> GraphState:
    query = state["query"]  # ê¸°ì¡´ ìƒíƒœ ì½ê¸°
    docs = pinecone_search(query)
    
    return {
        **state,  # ê¸°ì¡´ ìƒíƒœ ë³µì‚¬
        "relevant_docs": docs,  # ìƒˆ í•„ë“œ ì—…ë°ì´íŠ¸
        "num_sources": len(docs)
    }
```

---

### 5.5 ëŒ€í™” ê¸°ë¡ ìœ ì§€ (MemorySaver)

**MemorySaverë€?**
- LangGraphì˜ **ì²´í¬í¬ì¸íŠ¸(Checkpoint) ë©”ì»¤ë‹ˆì¦˜**
- ê° ì„¸ì…˜(`thread_id`)ë³„ë¡œ ìƒíƒœë¥¼ ì €ì¥/ë³µì›

**ë™ì‘ ë°©ì‹:**

1. **ì„¸ì…˜ ì‹œì‘** (`chatbot/app.py`):
   ```python
   # Streamlitì—ì„œ UUID ê¸°ë°˜ thread_id ìƒì„±
   thread_id = str(uuid.uuid4())
   st.session_state.thread_id = thread_id
   ```

2. **ìƒíƒœ ì €ì¥**:
   - LangGraph ì›Œí¬í”Œë¡œìš° ì™„ë£Œ ì‹œ ìë™ ì €ì¥
   - ì €ì¥ ìœ„ì¹˜: ë©”ëª¨ë¦¬ (MemorySaverëŠ” ì¸ë©”ëª¨ë¦¬ ì €ì¥ì†Œ)

3. **ìƒíƒœ ë³µì›**:
   ```python
   config = {"configurable": {"thread_id": thread_id}}
   final_state = rag_graph.invoke(initial_state, config=config)
   ```
   - ë™ì¼í•œ `thread_id`ë¡œ ì¬í˜¸ì¶œ ì‹œ ì´ì „ `messages` ìë™ ë¡œë“œ

**ì„¸ì…˜ ê²©ë¦¬:**
- ë¸Œë¼ìš°ì € íƒ­ë§ˆë‹¤ ê³ ìœ í•œ `thread_id`
- ê° ì„¸ì…˜ì€ ë…ë¦½ì ì¸ ëŒ€í™” ê¸°ë¡ ìœ ì§€

---

### 5.6 Streamlit ì›¹ ì¸í„°í˜ì´ìŠ¤

**í•µì‹¬ ê¸°ëŠ¥:**

1. **ëŒ€í™” UI**:
   ```python
   st.chat_message("user").markdown(prompt)
   st.chat_message("assistant").markdown(response)
   ```

2. **ì„¸ì…˜ ìƒíƒœ ê´€ë¦¬**:
   ```python
   st.session_state.messages = []  # ëŒ€í™” ê¸°ë¡
   st.session_state.thread_id = "..."  # ì„¸ì…˜ ID
   ```

3. **ì±—ë´‡ í˜¸ì¶œ**:
   ```python
   result = chat(query, thread_id=st.session_state.thread_id)
   ```

4. **ì‘ë‹µ í‘œì‹œ**:
   - ë‹µë³€ë§Œ í‘œì‹œ (ì¶œì²˜ëŠ” ì œê±°ë¨)
   - ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€

**ì‚¬ìš© ê¸°ìˆ :**
- Streamlit `chat_message`, `chat_input`
- `st.session_state` (ì„¸ì…˜ë³„ ìƒíƒœ ê´€ë¦¬)
- `st.spinner` (ë¡œë”© í‘œì‹œ)

---

### 5.7 ì „ì²´ ë°ì´í„° íë¦„ ìš”ì•½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ì‚¬ìš©ì ì…ë ¥: "ë§ˆí¬êµ¬ ì¥ë¡€ì‹ì¥ ì•Œë ¤ì¤˜"                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. rewrite_node (GPT-4o mini)                           â”‚
â”‚    â†’ "ë§ˆí¬êµ¬ ì¥ë¡€ì‹ì¥ ì¥ë¡€ì‹ì¥ ëª©ë¡ ì„œìš¸íŠ¹ë³„ì‹œ ë§ˆí¬êµ¬"      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. search_node (Pinecone)                               â”‚
â”‚    â†’ Embedding ìƒì„± (1536ì°¨ì› ë²¡í„°)                      â”‚
â”‚    â†’ Cosine Similarity ê²€ìƒ‰                             â”‚
â”‚    â†’ Top 15 ë¬¸ì„œ ë°˜í™˜                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. format_context_node                                  â”‚
â”‚    â†’ 15ê°œ ë¬¸ì„œë¥¼ êµ¬ì¡°í™”ëœ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜                   â”‚
â”‚    â†’ "[ì¶œì²˜: ...]\nì£¼ì†Œ: ...\nì „í™”ë²ˆí˜¸: ..." í˜•ì‹        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. generate_node (GPT-4o mini)                          â”‚
â”‚    â†’ System Prompt + ëŒ€í™” ê¸°ë¡ + Context + ì§ˆë¬¸         â”‚
â”‚    â†’ "ë§ˆí¬êµ¬ì— ìœ„ì¹˜í•œ ì¥ë¡€ì‹ì¥ìœ¼ë¡œëŠ”..."                  â”‚
â”‚    â†’ messages ì—…ë°ì´íŠ¸ (ë‹¤ìŒ í„´ì„ ìœ„í•´)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. MemorySaver                                          â”‚
â”‚    â†’ thread_idë¡œ ìƒíƒœ ì €ì¥                               â”‚
â”‚    â†’ ë‹¤ìŒ ì§ˆë¬¸ ì‹œ ëŒ€í™” ê¸°ë¡ ìë™ ë¡œë“œ                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Streamlit UI                                         â”‚
â”‚    â†’ ë‹µë³€ í‘œì‹œ                                           â”‚
â”‚    â†’ ëŒ€í™” íˆìŠ¤í† ë¦¬ì— ì¶”ê°€                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### 5.8 í•µì‹¬ ê¸°ìˆ  ìš”ì•½

| ê¸°ìˆ  | ì—­í•  | ì‚¬ìš© ìœ„ì¹˜ |
|-----|------|---------|
| **LangGraph** | ì›Œí¬í”Œë¡œìš° ê´€ë¦¬, ìƒíƒœ ê´€ë¦¬ | `chatbot/src/chatbot.py` (create_rag_graph) |
| **LangChain** | LLM í†µí•©, í”„ë¡¬í”„íŠ¸ ê´€ë¦¬ | `ChatOpenAI`, `OpenAIEmbeddings` |
| **MemorySaver** | ëŒ€í™” ê¸°ë¡ ìœ ì§€ | LangGraph checkpointer |
| **Pinecone** | ë²¡í„° ê²€ìƒ‰ | `search_node` |
| **GPT-4o mini** | ì¿¼ë¦¬ ì¬ì‘ì„±, ë‹µë³€ ìƒì„± | `rewrite_node`, `generate_node` |
| **text-embedding-3-small** | ë²¡í„° ì„ë² ë”© | ì¸ë±ì‹± & ê²€ìƒ‰ ì‹œ |
| **Streamlit** | ì›¹ UI | `chatbot/app.py` |

---

### 5.9 ì„±ëŠ¥ ìµœì í™” í¬ì¸íŠ¸

1. **ê²€ìƒ‰ ê²°ê³¼ ìˆ˜ ì¡°ì •**:
   - `n_results = 15`: Recall ìš°ì„  (ë” ë§ì€ ì •ë³´ ê²€ìƒ‰)
   - íŠ¸ë ˆì´ë“œì˜¤í”„: ì‘ë‹µ ì†ë„ vs. ì •í™•ë„

2. **ì¿¼ë¦¬ ì¬ì‘ì„±**:
   - ëª¨í˜¸í•œ ì§ˆë¬¸ â†’ êµ¬ì²´ì  í‚¤ì›Œë“œ
   - ê²€ìƒ‰ ì„±ëŠ¥ ì•½ 30% í–¥ìƒ (ê²½í—˜ì  ì¶”ì •)

3. **ì²­í¬ ì˜¤ë²„ë©**:
   - 100ì ì˜¤ë²„ë©ìœ¼ë¡œ ë¬¸ë§¥ ë³´ì¡´
   - ë²•ë¥  ì¡°ë¬¸ ê°™ì€ ê¸´ í…ìŠ¤íŠ¸ì—ì„œ íš¨ê³¼ì 

4. **ëŒ€í™” ê¸°ë¡ ì œí•œ**:
   - ìµœê·¼ 5ê°œ ëŒ€í™”ë§Œ ë¡œë“œ
   - ì»¨í…ìŠ¤íŠ¸ ê¸¸ì´ ì œí•œ (8192 í† í°) íšŒí”¼

5. **Namespace ë¶„ë¦¬**:
   - `well-dying` namespaceë§Œ ê²€ìƒ‰
   - ë¶ˆí•„ìš”í•œ íŒ€ì› ë°ì´í„° ì œì™¸ â†’ ê²€ìƒ‰ ì •í™•ë„ í–¥ìƒ

---

## ğŸ“ˆ ì„±ê³¼ ë° í†µê³„

- **ì´ ë°ì´í„° ìˆ˜**: 2,754ê°œ
- **ì¸ë±ì‹± ì„±ê³µë¥ **: 99.96% (1ê°œ í† í° ê¸¸ì´ ì´ˆê³¼ ì˜¤ë¥˜)
- **í‰ê·  ì‘ë‹µ ì‹œê°„**: ì•½ 2-3ì´ˆ
- **ê²€ìƒ‰ ì •í™•ë„**: ì •ì„±ì ìœ¼ë¡œ ìš°ìˆ˜ (ë§ˆí¬êµ¬ ì¥ë¡€ì‹ì¥ ë“± í…ŒìŠ¤íŠ¸ í†µê³¼)
- **ëŒ€í™” ê¸°ë¡ ìœ ì§€**: ì„¸ì…˜ë³„ ì™„ë²½ ì‘ë™

---

## ğŸ”® í–¥í›„ ê°œì„  ë°©í–¥

1. **ì„ë² ë”© ëª¨ë¸ ì—…ê·¸ë ˆì´ë“œ**: `text-embedding-3-large` (ì„±ëŠ¥ í–¥ìƒ)
2. **í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰**: í‚¤ì›Œë“œ + ë²¡í„° ê²€ìƒ‰ ê²°í•©
3. **Re-ranking**: ê²€ìƒ‰ ê²°ê³¼ ì¬ì •ë ¬ (Cohere Rerank ë“±)
4. **RAG Evaluation**: LangSmith ë“±ì„ í™œìš©í•œ ì •ëŸ‰ì  í‰ê°€
5. **ë°°í¬**: AWS Lambda + API Gateway ë“± ì„œë²„ë¦¬ìŠ¤ ë°°í¬

---

**ì‘ì„±ì¼**: 2025-11-23  
**ì‘ì„±ì**: KSU
